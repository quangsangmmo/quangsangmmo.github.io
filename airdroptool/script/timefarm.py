api_key = "aW1wb3J0IHJlcXVlc3RzLCB0aW1lCmltcG9ydCBqc29uLCByYW5kb20sIHN0cmluZywgb3MKZnJvbSBkYXRldGltZSBpbXBvcnQgZGF0ZXRpbWUsIHRpbWV6b25lCmZyb20gdGVybWNvbG9yIGltcG9ydCBjb2xvcmVkCmZyb20gZnVuY3Rpb24gaW1wb3J0ICoKdmVyc2lvbiA9ICI2LjAuMCIKbmFtZV90b29sID0gInRpbWVmYXJtIgpCQU5ORVIobmFtZV90b29sLCB2ZXJzaW9uKQpwcmludChmIiIiCnvEkeG7j33in6l7dsOgbmd94p+pe2zhu6VjfeKfqSB7bGFtfUPDgUMgQ0jhu6hDIE7Egk5HIEPhu6ZBIFRPT0wKe8SR4buPfVt7dsOgbmd9K3vEkeG7j31dIHt0cuG6r25nfUF1dG8gc3RhcnQgZmFybSAKe8SR4buPfVt7dsOgbmd9K3vEkeG7j31dIHt0cuG6r25nfUF1dG8gY2xhaW0gZmFybQp7xJHhu499W3t2w6BuZ30re8SR4buPfV0ge3Ry4bqvbmd9QXV0byBuw6JuZyBj4bqlcCAKe8SR4buPfVt7dsOgbmd9K3vEkeG7j31dIHt0cuG6r25nfUF1dG8gc3Rha2luZwp7xJHhu499W3t2w6BuZ30re8SR4buPfV0ge3Ry4bqvbmd9QXV0byBob8OgbiB0aMOgbmggY8OhYyBuaGnhu4dtIHbhu6UgKG5nb8OgaSBUZWxlZ3JhbSkKe8SR4buPfVt7dsOgbmd9K3vEkeG7j31dIHt0cuG6r25nfUF1dG8gbMOgbSBuaGnhu4dtIHbhu6UgdHLhuqMgbOG7nWkgY8OidSBo4buPaQoiIiIpCmFuc3dlciA9IHJlcXVlc3RzLmdldCgiaHR0cHM6Ly9xdWFuZ3NhbmdtbW8uZ2l0aHViLmlvL2FpcmRyb3B0b29sL2Fuc3dlci5qc29uIikuanNvbigpCmRlZiBnZXRVc2VySW5mbyhoZWFkZXJzLCBkYXRhLCBwcm94aWVzPU5vbmUpOgogIGVycm9yX2NvdW50ID0gMAogIG1heF9yZXRyaWVzID0gMTAKICBoZWFkZXJzWyJjb250ZW50LWxlbmd0aCJdID0gc3RyKGxlbihzdHIoZGF0YSkucmVwbGFjZSgiICIsIiIpKSkKICB3aGlsZSBUcnVlOgogICAgdHJ5OgogICAgICBpZiBwcm94aWVzOgogICAgICAgIHJlc3BvbnNlID0gcmVxdWVzdHMucG9zdCgiaHR0cHM6Ly90Zy1ib3QtdGFwLmxhYm9yeC5pby9hcGkvdjEvYXV0aC92YWxpZGF0ZS1pbml0L3YyIiwgaGVhZGVycz1oZWFkZXJzLCBqc29uPWRhdGEsIHByb3hpZXM9cHJveGllcywgdGltZW91dD0zMCkKICAgICAgZWxzZToKICAgICAgICByZXNwb25zZSA9IHJlcXVlc3RzLnBvc3QoImh0dHBzOi8vdGctYm90LXRhcC5sYWJvcnguaW8vYXBpL3YxL2F1dGgvdmFsaWRhdGUtaW5pdC92MiIsaGVhZGVycz1oZWFkZXJzLCBqc29uPWRhdGEsIHRpbWVvdXQ9MzApCiAgICAgIHJlc3BvbnNlLnJhaXNlX2Zvcl9zdGF0dXMoKQogICAgICBnZXRkYXRhID0gcmVzcG9uc2UuanNvbigpCiAgICAgIHRva2VuID0gZ2V0ZGF0YVsidG9rZW4iXQogICAgICBiYWxhbmNlID0gZ2V0ZGF0YVsiYmFsYW5jZUluZm8iXVsiYmFsYW5jZSJdCiAgICAgIGxldmVsID0gZ2V0ZGF0YVsiaW5mbyJdWyJsZXZlbCJdCiAgICAgIGxldmVsSW5mbyA9IGdldGRhdGFbImxldmVsRGVzY3JpcHRpb25zIl0KICAgICAgaGVhZGVycy5wb3AoImNvbnRlbnQtbGVuZ3RoIikKICAgICAgYnJlYWsKICAgIGV4Y2VwdDoKICAgICAgZXJyb3JfY291bnQgPSBoYW5kbGVFcnJvcnMoZXJyb3JfY291bnQsIG1heF9yZXRyaWVzKQogICAgaWYgZXJyb3JfY291bnQgPj0gbWF4X3JldHJpZXM6CiAgICAgIG5vd190aW1lID0gZGF0ZXRpbWUubm93KCkuc3RyZnRpbWUoIiVIOiVNOiVTIikKICAgICAgcHJpbnQoZiJ7xJHhu4994p+oe3bDoG5nfXtub3dfdGltZX17xJHhu4994p+pIHt0cuG6r25nfcSQw6MgZ+G6t3AgbOG7l2kgcXXDoSAxMCBs4bqnbiwga2jhu59pIGNo4bqheSBs4bqhaSB0b29sIFRJTUVGQVJNIikKICAgICAgUlVOX1RJTUVGQVJNKCkKICAgICAgYnJlYWsKICAgIENPVU5URE9XTigxMCkKICByZXR1cm4gdG9rZW4sIGJhbGFuY2UsIGxldmVsLCBsZXZlbEluZm8KZGVmIGZhcm1JbmZvKGhlYWRlcnMsIHByb3hpZXM9Tm9uZSk6CiAgZXJyb3JfY291bnQgPSAwCiAgbWF4X3JldHJpZXMgPSAxMAogIHdoaWxlIFRydWU6CiAgICB0cnk6CiAgICAgIGlmIHByb3hpZXM6CiAgICAgICAgcmVzcG9uc2UgPSByZXF1ZXN0cy5nZXQoImh0dHBzOi8vdGctYm90LXRhcC5sYWJvcnguaW8vYXBpL3YxL2Zhcm1pbmcvaW5mbyIsIGhlYWRlcnM9aGVhZGVycywgcHJveGllcz1wcm94aWVzLCB0aW1lb3V0PTMwKQogICAgICBlbHNlOgogICAgICAgIHJlc3BvbnNlID0gcmVxdWVzdHMuZ2V0KCJodHRwczovL3RnLWJvdC10YXAubGFib3J4LmlvL2FwaS92MS9mYXJtaW5nL2luZm8iLGhlYWRlcnM9aGVhZGVycywgdGltZW91dD0zMCkKICAgICAgcmVzcG9uc2UucmFpc2VfZm9yX3N0YXR1cygpCiAgICAgIGdldGRhdGEgPSByZXNwb25zZS5qc29uKCkKICAgICAgYmFsYW5jZSA9IGdldGRhdGFbImJhbGFuY2UiXQogICAgICB0aW1lU3RhcnRGYXJtID0gZ2V0ZGF0YVsiYWN0aXZlRmFybWluZ1N0YXJ0ZWRBdCJdCiAgICAgIHRpbWVGYXJtID0gZ2V0ZGF0YVsiZmFybWluZ0R1cmF0aW9uSW5TZWMiXQogICAgICByZXdhcmRGYXJtID0gZ2V0ZGF0YVsiZmFybWluZ1Jld2FyZCJdCiAgICAgIGlmIHRpbWVTdGFydEZhcm0gPT0gTm9uZToKICAgICAgICBiYWxhbmNlLCB0aW1lU3RhcnRGYXJtLCB0aW1lRmFybSwgcmV3YXJkRmFybSA9IHN0YXJ0RmFybShoZWFkZXJzLCBwcm94aWVzKQogICAgICBicmVhawogICAgZXhjZXB0OgogICAgICBlcnJvcl9jb3VudCA9IGhhbmRsZUVycm9ycyhlcnJvcl9jb3VudCwgbWF4X3JldHJpZXMpCiAgICBpZiBlcnJvcl9jb3VudCA+PSBtYXhfcmV0cmllczoKICAgICAgbm93X3RpbWUgPSBkYXRldGltZS5ub3coKS5zdHJmdGltZSgiJUg6JU06JVMiKQogICAgICBwcmludChmInvEkeG7j33in6h7dsOgbmd9e25vd190aW1lfXvEkeG7j33in6kge3Ry4bqvbmd9xJDDoyBn4bq3cCBs4buXaSBxdcOhIDEwIGzhuqduLCBraOG7n2kgY2jhuqF5IGzhuqFpIHRvb2wgVElNRUZBUk0iKQogICAgICBSVU5fVElNRUZBUk0oKQogICAgICBicmVhawogICAgQ09VTlRET1dOKDEwKQogIHJldHVybiBiYWxhbmNlLCB0aW1lU3RhcnRGYXJtLCB0aW1lRmFybSwgcmV3YXJkRmFybQpkZWYgY2xhaW1GYXJtKGhlYWRlcnMsIHByb3hpZXM9Tm9uZSk6CiAgZXJyb3JfY291bnQgPSAwCiAgbWF4X3JldHJpZXMgPSAxMAogIHdoaWxlIFRydWU6CiAgICB0cnk6CiAgICAgIGlmIHByb3hpZXM6CiAgICAgICAgcmVzcG9uc2UgPSByZXF1ZXN0cy5wb3N0KCJodHRwczovL3RnLWJvdC10YXAubGFib3J4LmlvL2FwaS92MS9mYXJtaW5nL2ZpbmlzaCIsIGhlYWRlcnM9aGVhZGVycywganNvbj17fSwgcHJveGllcz1wcm94aWVzLCB0aW1lb3V0PTMwKQogICAgICBlbHNlOgogICAgICAgIHJlc3BvbnNlID0gcmVxdWVzdHMucG9zdCgiaHR0cHM6Ly90Zy1ib3QtdGFwLmxhYm9yeC5pby9hcGkvdjEvZmFybWluZy9maW5pc2giLGhlYWRlcnM9aGVhZGVycywganNvbj17fSkKICAgICAgcmVzcG9uc2UucmFpc2VfZm9yX3N0YXR1cygpCiAgICAgIGdldGRhdGEgPSByZXNwb25zZS5qc29uKCkKICAgICAgYmFsYW5jZSA9IGdldGRhdGFbImJhbGFuY2UiXQogICAgICBicmVhawogICAgZXhjZXB0OgogICAgICBlcnJvcl9jb3VudCA9IGhhbmRsZUVycm9ycyhlcnJvcl9jb3VudCwgbWF4X3JldHJpZXMpCiAgICBpZiBlcnJvcl9jb3VudCA+PSBtYXhfcmV0cmllczoKICAgICAgbm93X3RpbWUgPSBkYXRldGltZS5ub3coKS5zdHJmdGltZSgiJUg6JU06JVMiKQogICAgICBwcmludChmInvEkeG7j33in6h7dsOgbmd9e25vd190aW1lfXvEkeG7j33in6kge3Ry4bqvbmd9xJDDoyBn4bq3cCBs4buXaSBxdcOhIDEwIGzhuqduLCBraOG7n2kgY2jhuqF5IGzhuqFpIHRvb2wgVElNRUZBUk0iKQogICAgICBSVU5fVElNRUZBUk0oKQogICAgICBicmVhawogICAgQ09VTlRET1dOKDEwKQogIHJldHVybiBiYWxhbmNlCmRlZiBzdGFydEZhcm0oaGVhZGVycywgcHJveGllcz1Ob25lKToKICBlcnJvcl9jb3VudCA9IDAKICBtYXhfcmV0cmllcyA9IDEwCiAgd2hpbGUgVHJ1ZToKICAgIHRyeToKICAgICAgaWYgcHJveGllczoKICAgICAgICByZXNwb25zZSA9IHJlcXVlc3RzLnBvc3QoImh0dHBzOi8vdGctYm90LXRhcC5sYWJvcnguaW8vYXBpL3YxL2Zhcm1pbmcvc3RhcnQiLCBoZWFkZXJzPWhlYWRlcnMsIGpzb249e30sIHByb3hpZXM9cHJveGllcywgdGltZW91dD0zMCkKICAgICAgZWxzZToKICAgICAgICByZXNwb25zZSA9IHJlcXVlc3RzLnBvc3QoImh0dHBzOi8vdGctYm90LXRhcC5sYWJvcnguaW8vYXBpL3YxL2Zhcm1pbmcvc3RhcnQiLGhlYWRlcnM9aGVhZGVycywganNvbj17fSkKICAgICAgcmVzcG9uc2UucmFpc2VfZm9yX3N0YXR1cygpCiAgICAgIGdldGRhdGEgPSByZXNwb25zZS5qc29uKCkKICAgICAgYmFsYW5jZSA9IGdldGRhdGFbImJhbGFuY2UiXQogICAgICB0aW1lU3RhcnRGYXJtID0gZ2V0ZGF0YVsiYWN0aXZlRmFybWluZ1N0YXJ0ZWRBdCJdCiAgICAgIHRpbWVGYXJtID0gZ2V0ZGF0YVsiZmFybWluZ0R1cmF0aW9uSW5TZWMiXQogICAgICByZXdhcmRGYXJtID0gZ2V0ZGF0YVsiZmFybWluZ1Jld2FyZCJdCiAgICAgIG5vd190aW1lID0gZGF0ZXRpbWUubm93KCkuc3RyZnRpbWUoIiVIOiVNOiVTIikKICAgICAgcHJpbnQoZiJ7xJHhu4994p+oe3bDoG5nfXtub3dfdGltZX17xJHhu4994p+pIHts4bulY33EkMOjIGLhuq90IMSR4bqndSBGQVJNIHt2w6BuZ30re3Jld2FyZEZhcm06LH0ge2zhu6VjfXNhdSBraGkga+G6v3QgdGjDumMiKQogICAgICBicmVhawogICAgZXhjZXB0OgogICAgICBlcnJvcl9jb3VudCA9IGhhbmRsZUVycm9ycyhlcnJvcl9jb3VudCwgbWF4X3JldHJpZXMpCiAgICBpZiBlcnJvcl9jb3VudCA+PSBtYXhfcmV0cmllczoKICAgICAgbm93X3RpbWUgPSBkYXRldGltZS5ub3coKS5zdHJmdGltZSgiJUg6JU06JVMiKQogICAgICBwcmludChmInvEkeG7j33in6h7dsOgbmd9e25vd190aW1lfXvEkeG7j33in6kge3Ry4bqvbmd9xJDDoyBn4bq3cCBs4buXaSBxdcOhIDEwIGzhuqduLCBraOG7n2kgY2jhuqF5IGzhuqFpIHRvb2wgVElNRUZBUk0iKQogICAgICBSVU5fVElNRUZBUk0oKQogICAgICBicmVhawogICAgQ09VTlRET1dOKDEwKQogIHJldHVybiBiYWxhbmNlLCB0aW1lU3RhcnRGYXJtLCB0aW1lRmFybSwgcmV3YXJkRmFybQpkZWYgdGFza3NJbmZvKGhlYWRlcnMsIHByb3hpZXM9Tm9uZSk6CiAgZXJyb3JfY291bnQgPSAwCiAgbWF4X3JldHJpZXMgPSAxMAogIHdoaWxlIFRydWU6CiAgICB0cnk6CiAgICAgIGlmIHByb3hpZXM6CiAgICAgICAgcmVzcG9uc2UgPSByZXF1ZXN0cy5nZXQoImh0dHBzOi8vdGctYm90LXRhcC5sYWJvcnguaW8vYXBpL3YxL3Rhc2tzIiwgaGVhZGVycz1oZWFkZXJzLCBwcm94aWVzPXByb3hpZXMsIHRpbWVvdXQ9MzApCiAgICAgIGVsc2U6CiAgICAgICAgcmVzcG9uc2UgPSByZXF1ZXN0cy5nZXQoImh0dHBzOi8vdGctYm90LXRhcC5sYWJvcnguaW8vYXBpL3YxL3Rhc2tzIixoZWFkZXJzPWhlYWRlcnMsIHRpbWVvdXQ9MzApCiAgICAgIHJlc3BvbnNlLnJhaXNlX2Zvcl9zdGF0dXMoKQogICAgICB0YXNrc0xpc3QgPSByZXNwb25zZS5qc29uKCkKICAgICAgYnJlYWsKICAgIGV4Y2VwdDoKICAgICAgZXJyb3JfY291bnQgPSBoYW5kbGVFcnJvcnMoZXJyb3JfY291bnQsIG1heF9yZXRyaWVzKQogICAgaWYgZXJyb3JfY291bnQgPj0gbWF4X3JldHJpZXM6CiAgICAgIG5vd190aW1lID0gZGF0ZXRpbWUubm93KCkuc3RyZnRpbWUoIiVIOiVNOiVTIikKICAgICAgcHJpbnQoZiJ7xJHhu4994p+oe3bDoG5nfXtub3dfdGltZX17xJHhu4994p+pIHt0cuG6r25nfcSQw6MgZ+G6t3AgbOG7l2kgcXXDoSAxMCBs4bqnbiwga2jhu59pIGNo4bqheSBs4bqhaSB0b29sIFRJTUVGQVJNIikKICAgICAgUlVOX1RJTUVGQVJNKCkKICAgICAgYnJlYWsKICAgIENPVU5URE9XTigxMCkKICByZXR1cm4gdGFza3NMaXN0CmRlZiBzdGFydFRhc2soaGVhZGVycywgaWRfdGFzaywgcHJveGllcz1Ob25lKToKICBlcnJvcl9jb3VudCA9IDAKICBtYXhfcmV0cmllcyA9IDEwCiAgd2hpbGUgVHJ1ZToKICAgIHRyeToKICAgICAgaWYgcHJveGllczoKICAgICAgICByZXNwb25zZSA9IHJlcXVlc3RzLnBvc3QoZiJodHRwczovL3RnLWJvdC10YXAubGFib3J4LmlvL2FwaS92MS90YXNrcy97aWRfdGFza30vc3VibWlzc2lvbnMiLCBoZWFkZXJzPWhlYWRlcnMsIHByb3hpZXM9cHJveGllcywgdGltZW91dD0zMCkKICAgICAgZWxzZToKICAgICAgICByZXNwb25zZSA9IHJlcXVlc3RzLnBvc3QoZiJodHRwczovL3RnLWJvdC10YXAubGFib3J4LmlvL2FwaS92MS90YXNrcy97aWRfdGFza30vc3VibWlzc2lvbnMiLGhlYWRlcnM9aGVhZGVycywgdGltZW91dD0zMCkKICAgICAgcmVzcG9uc2UucmFpc2VfZm9yX3N0YXR1cygpCiAgICAgIHN0YXR1cyA9IHJlc3BvbnNlLnN0YXR1c19jb2RlCiAgICAgIGJyZWFrCiAgICBleGNlcHQ6CiAgICAgIGVycm9yX2NvdW50ID0gaGFuZGxlRXJyb3JzKGVycm9yX2NvdW50LCBtYXhfcmV0cmllcykKICAgIGlmIGVycm9yX2NvdW50ID49IG1heF9yZXRyaWVzOgogICAgICBub3dfdGltZSA9IGRhdGV0aW1lLm5vdygpLnN0cmZ0aW1lKCIlSDolTTolUyIpCiAgICAgIHByaW50KGYie8SR4buPfeKfqHt2w6BuZ317bm93X3RpbWV9e8SR4buPfeKfqSB7dHLhuq9uZ33EkMOjIGfhurdwIGzhu5dpIHF1w6EgMTAgbOG6p24sIGto4bufaSBjaOG6oXkgbOG6oWkgdG9vbCBUSU1FRkFSTSIpCiAgICAgIFJVTl9USU1FRkFSTSgpCiAgICAgIGJyZWFrCiAgICBDT1VOVERPV04oMTApCiAgcmV0dXJuIHN0YXR1cwpkZWYgY2xhaW1UYXNrKGhlYWRlcnMsIGlkX3Rhc2ssIHByb3hpZXM9Tm9uZSk6CiAgZXJyb3JfY291bnQgPSAwCiAgbWF4X3JldHJpZXMgPSAxMAogIHdoaWxlIFRydWU6CiAgICB0cnk6CiAgICAgIGlmIHByb3hpZXM6CiAgICAgICAgcmVzcG9uc2UgPSByZXF1ZXN0cy5wb3N0KGYiaHR0cHM6Ly90Zy1ib3QtdGFwLmxhYm9yeC5pby9hcGkvdjEvdGFza3Mve2lkX3Rhc2t9L2NsYWltcyIsIGhlYWRlcnM9aGVhZGVycywganNvbj17fSwgcHJveGllcz1wcm94aWVzLCB0aW1lb3V0PTMwKQogICAgICBlbHNlOgogICAgICAgIHJlc3BvbnNlID0gcmVxdWVzdHMucG9zdChmImh0dHBzOi8vdGctYm90LXRhcC5sYWJvcnguaW8vYXBpL3YxL3Rhc2tzL3tpZF90YXNrfS9jbGFpbXMiLGhlYWRlcnM9aGVhZGVycywganNvbj17fSkKICAgICAgcmVzcG9uc2UucmFpc2VfZm9yX3N0YXR1cygpCiAgICAgIHN0YXR1cyA9IHJlc3BvbnNlLnN0YXR1c19jb2RlCiAgICAgIGJyZWFrCiAgICBleGNlcHQ6CiAgICAgIGVycm9yX2NvdW50ID0gaGFuZGxlRXJyb3JzKGVycm9yX2NvdW50LCBtYXhfcmV0cmllcykKICAgIGlmIGVycm9yX2NvdW50ID49IG1heF9yZXRyaWVzOgogICAgICBub3dfdGltZSA9IGRhdGV0aW1lLm5vdygpLnN0cmZ0aW1lKCIlSDolTTolUyIpCiAgICAgIHByaW50KGYie8SR4buPfeKfqHt2w6BuZ317bm93X3RpbWV9e8SR4buPfeKfqSB7dHLhuq9uZ33EkMOjIGfhurdwIGzhu5dpIHF1w6EgMTAgbOG6p24sIGto4bufaSBjaOG6oXkgbOG6oWkgdG9vbCBUSU1FRkFSTSIpCiAgICAgIFJVTl9USU1FRkFSTSgpCiAgICAgIGJyZWFrCiAgICBDT1VOVERPV04oMTApCiAgcmV0dXJuIHN0YXR1cwpkZWYgZ2V0QmFsYW5jZShoZWFkZXJzLCBwcm94aWVzPU5vbmUpOgogIGVycm9yX2NvdW50ID0gMAogIG1heF9yZXRyaWVzID0gMTAKICB3aGlsZSBUcnVlOgogICAgdHJ5OgogICAgICBpZiBwcm94aWVzOgogICAgICAgIHJlc3BvbnNlID0gcmVxdWVzdHMuZ2V0KGYiaHR0cHM6Ly90Zy1ib3QtdGFwLmxhYm9yeC5pby9hcGkvdjEvYmFsYW5jZSIsIGhlYWRlcnM9aGVhZGVycywgcHJveGllcz1wcm94aWVzLCB0aW1lb3V0PTMwKQogICAgICBlbHNlOgogICAgICAgIHJlc3BvbnNlID0gcmVxdWVzdHMuZ2V0KGYiaHR0cHM6Ly90Zy1ib3QtdGFwLmxhYm9yeC5pby9hcGkvdjEvYmFsYW5jZSIsaGVhZGVycz1oZWFkZXJzLCB0aW1lb3V0PTMwKQogICAgICByZXNwb25zZS5yYWlzZV9mb3Jfc3RhdHVzKCkKICAgICAgYmFsYW5jZSA9IHJlc3BvbnNlLmpzb24oKVsiYmFsYW5jZSJdCiAgICAgIGJyZWFrCiAgICBleGNlcHQ6CiAgICAgIGVycm9yX2NvdW50ID0gaGFuZGxlRXJyb3JzKGVycm9yX2NvdW50LCBtYXhfcmV0cmllcykKICAgIGlmIGVycm9yX2NvdW50ID49IG1heF9yZXRyaWVzOgogICAgICBub3dfdGltZSA9IGRhdGV0aW1lLm5vdygpLnN0cmZ0aW1lKCIlSDolTTolUyIpCiAgICAgIHByaW50KGYie8SR4buPfeKfqHt2w6BuZ317bm93X3RpbWV9e8SR4buPfeKfqSB7dHLhuq9uZ33EkMOjIGfhurdwIGzhu5dpIHF1w6EgMTAgbOG6p24sIGto4bufaSBjaOG6oXkgbOG6oWkgdG9vbCBUSU1FRkFSTSIpCiAgICAgIFJVTl9USU1FRkFSTSgpCiAgICAgIGJyZWFrCiAgICBDT1VOVERPV04oMTApCiAgcmV0dXJuIGJhbGFuY2UKZGVmIHVwZ3JhZGUoaGVhZGVycywgcHJveGllcz1Ob25lKToKICBlcnJvcl9jb3VudCA9IDAKICBtYXhfcmV0cmllcyA9IDEwCiAgaGVhZGVyc1siY29udGVudC1sZW5ndGgiXSA9ICIyIgogIHdoaWxlIFRydWU6CiAgICB0cnk6CiAgICAgIGlmIHByb3hpZXM6CiAgICAgICAgcmVzcG9uc2UgPSByZXF1ZXN0cy5wb3N0KGYiaHR0cHM6Ly90Zy1ib3QtdGFwLmxhYm9yeC5pby9hcGkvdjEvbWUvbGV2ZWwvdXBncmFkZSIsIGhlYWRlcnM9aGVhZGVycywganNvbj17fSwgcHJveGllcz1wcm94aWVzLCB0aW1lb3V0PTMwKQogICAgICBlbHNlOgogICAgICAgIHJlc3BvbnNlID0gcmVxdWVzdHMucG9zdChmImh0dHBzOi8vdGctYm90LXRhcC5sYWJvcnguaW8vYXBpL3YxL21lL2xldmVsL3VwZ3JhZGUiLGhlYWRlcnM9aGVhZGVycywganNvbj17fSwgdGltZW91dD0zMCkKICAgICAgcmVzcG9uc2UucmFpc2VfZm9yX3N0YXR1cygpCiAgICAgIGdldGRhdGEgPSByZXNwb25zZS5qc29uKCkKICAgICAgYmFsYW5jZSA9IGdldGRhdGFbImJhbGFuY2UiXQogICAgICBsZXZlbCA9IGdldGRhdGFbImxldmVsIl0KICAgICAgdGltZUZhcm0gPSBnZXRkYXRhWyJmYXJtaW5nSW5mbyJdWyJmYXJtaW5nRHVyYXRpb25JblNlYyJdCiAgICAgIHJld2FyZEZhcm0gPSBnZXRkYXRhWyJmYXJtaW5nSW5mbyJdWyJmYXJtaW5nUmV3YXJkIl0KICAgICAgaGVhZGVycy5wb3AoImNvbnRlbnQtbGVuZ3RoIikKICAgICAgYnJlYWsKICAgIGV4Y2VwdDoKICAgICAgZXJyb3JfY291bnQgPSBoYW5kbGVFcnJvcnMoZXJyb3JfY291bnQsIG1heF9yZXRyaWVzKQogICAgaWYgZXJyb3JfY291bnQgPj0gbWF4X3JldHJpZXM6CiAgICAgIG5vd190aW1lID0gZGF0ZXRpbWUubm93KCkuc3RyZnRpbWUoIiVIOiVNOiVTIikKICAgICAgcHJpbnQoZiJ7xJHhu4994p+oe3bDoG5nfXtub3dfdGltZX17xJHhu4994p+pIHt0cuG6r25nfcSQw6MgZ+G6t3AgbOG7l2kgcXXDoSAxMCBs4bqnbiwga2jhu59pIGNo4bqheSBs4bqhaSB0b29sIFRJTUVGQVJNIikKICAgICAgUlVOX1RJTUVGQVJNKCkKICAgICAgYnJlYWsKICAgIENPVU5URE9XTigxMCkKICByZXR1cm4gYmFsYW5jZSwgbGV2ZWwsIHRpbWVGYXJtLCByZXdhcmRGYXJtCmRlZiBTVEFLSU5HX0FDVElWRShoZWFkZXJzLCBwcm94aWVzPU5vbmUpOgogIGVycm9yX2NvdW50ID0gMAogIG1heF9yZXRyaWVzID0gMTAKICB3aGlsZSBUcnVlOgogICAgdHJ5OgogICAgICBpZiBwcm94aWVzOgogICAgICAgIHJlc3BvbnNlID0gcmVxdWVzdHMuZ2V0KGYiaHR0cHM6Ly90Zy1ib3QtdGFwLmxhYm9yeC5pby9hcGkvdjEvc3Rha2luZy9hY3RpdmUiLCBoZWFkZXJzPWhlYWRlcnMsIHByb3hpZXM9cHJveGllcywgdGltZW91dD0zMCkKICAgICAgZWxzZToKICAgICAgICByZXNwb25zZSA9IHJlcXVlc3RzLmdldChmImh0dHBzOi8vdGctYm90LXRhcC5sYWJvcnguaW8vYXBpL3YxL3N0YWtpbmcvYWN0aXZlIixoZWFkZXJzPWhlYWRlcnMsIHRpbWVvdXQ9MzApCiAgICAgIHJlc3BvbnNlLnJhaXNlX2Zvcl9zdGF0dXMoKQogICAgICBvcHRpb25zID0gcmVzcG9uc2UuanNvbigpWyJzdGFraW5nSW5mbyJdWyJvcHRpb25zIl0KICAgICAgc3Rha2VzID0gcmVzcG9uc2UuanNvbigpWyJzdGFrZXMiXQogICAgICBicmVhawogICAgZXhjZXB0OgogICAgICBlcnJvcl9jb3VudCA9IGhhbmRsZUVycm9ycyhlcnJvcl9jb3VudCwgbWF4X3JldHJpZXMpCiAgICBpZiBlcnJvcl9jb3VudCA+PSBtYXhfcmV0cmllczoKICAgICAgbm93X3RpbWUgPSBkYXRldGltZS5ub3coKS5zdHJmdGltZSgiJUg6JU06JVMiKQogICAgICBwcmludChmInvEkeG7j33in6h7dsOgbmd9e25vd190aW1lfXvEkeG7j33in6kge3Ry4bqvbmd9xJDDoyBn4bq3cCBs4buXaSBxdcOhIDEwIGzhuqduLCBraOG7n2kgY2jhuqF5IGzhuqFpIHRvb2wgVElNRUZBUk0iKQogICAgICBSVU5fVElNRUZBUk0oKQogICAgICBicmVhawogICAgQ09VTlRET1dOKDEwKQogIHJldHVybiBvcHRpb25zLCBzdGFrZXMKZGVmIFNUQUtJTkcoaGVhZGVycywgZGF0YSwgcHJveGllcz1Ob25lKToKICBlcnJvcl9jb3VudCA9IDAKICBtYXhfcmV0cmllcyA9IDEwCiAgaGVhZGVyc1siY29udGVudC1sZW5ndGgiXSA9IHN0cihsZW4oc3RyKGRhdGEpLnJlcGxhY2UoIiAiLCIiKSkpCiAgd2hpbGUgVHJ1ZToKICAgIHRyeToKICAgICAgaWYgcHJveGllczoKICAgICAgICByZXNwb25zZSA9IHJlcXVlc3RzLnBvc3QoZiJodHRwczovL3RnLWJvdC10YXAubGFib3J4LmlvL2FwaS92MS9zdGFraW5nIiwgaGVhZGVycz1oZWFkZXJzLCBqc29uPWRhdGEsIHByb3hpZXM9cHJveGllcywgdGltZW91dD0zMCkKICAgICAgZWxzZToKICAgICAgICByZXNwb25zZSA9IHJlcXVlc3RzLnBvc3QoZiJodHRwczovL3RnLWJvdC10YXAubGFib3J4LmlvL2FwaS92MS9zdGFraW5nIixoZWFkZXJzPWhlYWRlcnMsIGpzb249ZGF0YSwgdGltZW91dD0zMCkKICAgICAgcmVzcG9uc2UucmFpc2VfZm9yX3N0YXR1cygpCiAgICAgIGdldGRhdGEgPSByZXNwb25zZS5qc29uKCkKICAgICAgb3B0aW9ucyA9IHJlc3BvbnNlLmpzb24oKVsic3Rha2luZ0luZm8iXVsib3B0aW9ucyJdCiAgICAgIHN0YWtlcyA9IHJlc3BvbnNlLmpzb24oKVsic3Rha2VzIl0KICAgICAgaGVhZGVycy5wb3AoImNvbnRlbnQtbGVuZ3RoIikKICAgICAgYnJlYWsKICAgIGV4Y2VwdDoKICAgICAgZXJyb3JfY291bnQgPSBoYW5kbGVFcnJvcnMoZXJyb3JfY291bnQsIG1heF9yZXRyaWVzKQogICAgaWYgZXJyb3JfY291bnQgPj0gbWF4X3JldHJpZXM6CiAgICAgIG5vd190aW1lID0gZGF0ZXRpbWUubm93KCkuc3RyZnRpbWUoIiVIOiVNOiVTIikKICAgICAgcHJpbnQoZiJ7xJHhu4994p+oe3bDoG5nfXtub3dfdGltZX17xJHhu4994p+pIHt0cuG6r25nfcSQw6MgZ+G6t3AgbOG7l2kgcXXDoSAxMCBs4bqnbiwga2jhu59pIGNo4bqheSBs4bqhaSB0b29sIFRJTUVGQVJNIikKICAgICAgUlVOX1RJTUVGQVJNKCkKICAgICAgYnJlYWsKICAgIENPVU5URE9XTigxMCkKICByZXR1cm4gb3B0aW9ucywgc3Rha2VzCgpkZWYgREFJTFlfUVVFU1QoaGVhZGVycywgZGF0YSwgTUVUSE9ELCBwcm94aWVzPU5vbmUpOgogIGVycm9yX2NvdW50ID0gMAogIG1heF9yZXRyaWVzID0gMTAKICBoZWFkZXJzWyJjb250ZW50LWxlbmd0aCJdID0gc3RyKGxlbihzdHIoZGF0YSkucmVwbGFjZSgiICIsIiIpKSkKICB3aGlsZSBUcnVlOgogICAgdHJ5OgogICAgICBpZiBwcm94aWVzOgogICAgICAgIGlmIE1FVEhPRCA9PSAicG9zdCI6CiAgICAgICAgICByZXNwb25zZSA9IHJlcXVlc3RzLnBvc3QoZiJodHRwczovL3RnLWJvdC10YXAubGFib3J4LmlvL2FwaS92MS9kYWlseS1xdWVzdGlvbnMiLCBoZWFkZXJzPWhlYWRlcnMsIGpzb249ZGF0YSwgcHJveGllcz1wcm94aWVzLCB0aW1lb3V0PTMwKQogICAgICAgIGVsc2U6CiAgICAgICAgICByZXNwb25zZSA9IHJlcXVlc3RzLmdldChmImh0dHBzOi8vdGctYm90LXRhcC5sYWJvcnguaW8vYXBpL3YxL2RhaWx5LXF1ZXN0aW9ucyIsIGhlYWRlcnM9aGVhZGVycywgcHJveGllcz1wcm94aWVzLCB0aW1lb3V0PTMwKQogICAgICBlbHNlOgogICAgICAgIGlmIE1FVEhPRCA9PSAicG9zdCI6CiAgICAgICAgICByZXNwb25zZSA9IHJlcXVlc3RzLnBvc3QoZiJodHRwczovL3RnLWJvdC10YXAubGFib3J4LmlvL2FwaS92MS9kYWlseS1xdWVzdGlvbnMiLGhlYWRlcnM9aGVhZGVycywganNvbj1kYXRhLCB0aW1lb3V0PTMwKQogICAgICAgIGVsc2U6CiAgICAgICAgICByZXNwb25zZSA9IHJlcXVlc3RzLmdldChmImh0dHBzOi8vdGctYm90LXRhcC5sYWJvcnguaW8vYXBpL3YxL2RhaWx5LXF1ZXN0aW9ucyIsaGVhZGVycz1oZWFkZXJzLCB0aW1lb3V0PTMwKQogICAgICByZXNwb25zZS5yYWlzZV9mb3Jfc3RhdHVzKCkKICAgICAgZ2V0ZGF0YSA9IHJlc3BvbnNlLmpzb24oKQogICAgICAjcHJpbnQoZ2V0ZGF0YSkKICAgICAgaWYgTUVUSE9EID09ICJwb3N0IjoKICAgICAgICBpc0NvcnJlY3QgPSBnZXRkYXRhWyJpc0NvcnJlY3QiXQogICAgICBlbHNlOgogICAgICAgIGlmICJhbnN3ZXIiIGluIGdldGRhdGE6CiAgICAgICAgICBpc0NvcnJlY3QgPSBnZXRkYXRhWyJhbnN3ZXIiXVsiaXNDb3JyZWN0Il0KICAgICAgICBlbHNlOgogICAgICAgICAgaXNDb3JyZWN0ID0gRmFsc2UKICAgICAgYnJlYWsKICAgIGV4Y2VwdDoKICAgICAgZXJyb3JfY291bnQgPSBoYW5kbGVFcnJvcnMoZXJyb3JfY291bnQsIG1heF9yZXRyaWVzKQogICAgaWYgZXJyb3JfY291bnQgPj0gbWF4X3JldHJpZXM6CiAgICAgIG5vd190aW1lID0gZGF0ZXRpbWUubm93KCkuc3RyZnRpbWUoIiVIOiVNOiVTIikKICAgICAgcHJpbnQoZiJ7xJHhu4994p+oe3bDoG5nfXtub3dfdGltZX17xJHhu4994p+pIHt0cuG6r25nfcSQw6MgZ+G6t3AgbOG7l2kgcXXDoSAxMCBs4bqnbiwga2jhu59pIGNo4bqheSBs4bqhaSB0b29sIFRJTUVGQVJNIikKICAgICAgUlVOX1RJTUVGQVJNKCkKICAgICAgYnJlYWsKICAgIENPVU5URE9XTigxMCkKICByZXR1cm4gaXNDb3JyZWN0CgpkZWYgUlVOX1RJTUVGQVJNKCk6CiAgd2l0aCBvcGVuKCdjb25maWcvdGltZWZhcm0uanNvbicsICdyJywgZW5jb2Rpbmc9J3V0Zi04JykgYXMgZmlsZToKICAgIGNvbmZpZ19kYXRhID0ganNvbi5sb2FkcyhyZW1vdmVfY29tbWVudHMoZmlsZS5yZWFkKCkpKQogIHVzZXJzID0gY29uZmlnX2RhdGEKICBpZiBsZW4odXNlcnMpID4gMTA6CiAgICBwcmludCgiQuG6oW4gY2jhu4kgxJHGsOG7o2MgcGjDqXAgdGjDqm0gdOG7kWkgxJFhIDEwIHTDoGkga2hv4bqjbiDEkeG7gyBjaOG6oXkgdG9vbCIpCiAgICBleGl0KCkKICBmb3IgdXNlciBpbiB1c2VyczoKICAgIGFjY291bnQgPSB1c2VyWyJTVFRfQUNDT1VOVCJdCiAgICBhdXRob3JpemF0aW9uID0gdXNlclsiQVVUSE9SSVpBVElPTiJdCiAgICBpZiBhdXRob3JpemF0aW9uID09ICIiIG9yIGF1dGhvcml6YXRpb24gPT0gInRoYXlfdGjhur9fYuG6sW5nX2F1dGhvcml6YXRpb24iOgogICAgICBwcmludChmInvEkeG7j33in6l7dsOgbmd94p+pe2zhu6VjfeKfqSB7xJHhu499VMOgaSBraG/huqNuIHt2w6BuZ317YWNjb3VudC5zcGxpdCgnXycpWzFdfSB7xJHhu499YXV0aG9yaXphdGlvbiDEkWFuZyBi4buLIHRy4buRbmciKQogICAgICBjb250aW51ZQogICAgd2l0aCBvcGVuKCdjb25maWcvc2V0dGluZy5qc29uJywgJ3InLCBlbmNvZGluZz0ndXRmLTgnKSBhcyBmaWxlOgogICAgICBjb25maWdfYWNjID0ganNvbi5sb2FkcyhyZW1vdmVfY29tbWVudHMoZmlsZS5yZWFkKCkpKVthY2NvdW50XQogICAgcHJveHlfbGlzdCA9IGNvbmZpZ19hY2NbInByb3h5Il0KICAgIHR5cGVfcHJveHkgPSBjb25maWdfYWNjWyJ0eXBlX3Byb3h5Il0KICAgIHVzZXJfYWdlbnQgPSBjb25maWdfYWNjWyJ1c2VyLWFnZW50Il0KICAgIGlmIHByb3h5X2xpc3QgIT0gIiI6CiAgICAgIHByb3h5X2xpc3QgPSBwcm94eV9saXN0LnNwbGl0KCI6IikKICAgICAgcHJveHkgPSBmInt0eXBlX3Byb3h5fTovL3twcm94eV9saXN0WzJdfTp7cHJveHlfbGlzdFszXX1Ae3Byb3h5X2xpc3RbMF19Ontwcm94eV9saXN0WzFdfSIKICAgICAgcHJveGllcyA9IHsKICAgICAgJ2h0dHAnOiBwcm94eSwKICAgICAgJ2h0dHBzJzogcHJveHksfQogICAgZWxzZToKICAgICAgaWYgYWNjb3VudC5zcGxpdCgnXycpWzFdICE9ICIxIjoKICAgICAgICBwcmludChmInvEkeG7j33in6l7dsOgbmd94p+pe2zhu6VjfeKfqSB7dHLhuq9uZ31DaHV54buDbiB0w6BpIGtob+G6o24gZG8ga2jDtG5nIGPDsyBwcm94eSIpCiAgICAgICAgY29udGludWUKICAgICAgcHJveGllcyA9ICIiCiAgICBpcCwgZmFrZWlwID0gZ2V0SVAocHJveGllcykKICAgIGlmIGlwID09IGZha2VpcCA9PSBOb25lOgogICAgICBub3dfdGltZSA9IGRhdGV0aW1lLm5vdygpLnN0cmZ0aW1lKCIlSDolTTolUyIpCiAgICAgIHByaW50KGYie8SR4buPfeKfqXt2w6BuZ33in6l7bOG7pWN94p+pIHvEkeG7j31cbsSQ4buUSSBUw4BJIEtIT+G6ok4gRE8gS0jDlE5HIEzhuqRZIMSQxq/hu6JDIElQLCBIw4NZIEtJ4buCTSBUUkEgTOG6oEkgUFJPWFlcbiIpCiAgICAgIGNvbnRpbnVlCiAgICBoZWFkZXJzID0gewogICAgICAiSG9zdCI6ICJ0Zy1ib3QtdGFwLmxhYm9yeC5pbyIsCiAgICAgICJzZWMtY2gtdWEiOiAnIk5vdC9BKUJyYW5kIjt2PSI4IiwgIkNocm9taXVtIjt2PSIxMjYiLCAiQW5kcm9pZCBXZWJWaWV3Ijt2PSIxMjYiJywKICAgICAgInNlYy1jaC11YS1wbGF0Zm9ybSI6ICciQW5kcm9pZCInLAogICAgICAic2VjLWNoLXVhLW1vYmlsZSI6ICI/MSIsCiAgICAgICJ1c2VyLWFnZW50IjogdXNlcl9hZ2VudCwKICAgICAgImNvbnRlbnQtdHlwZSI6ICJhcHBsaWNhdGlvbi9qc29uIiwKICAgICAgImFjY2VwdCI6ICIqLyoiLAogICAgICAib3JpZ2luIjogImh0dHBzOi8vdGctdGFwLW1pbmlhcHAubGFib3J4LmlvIiwKICAgICAgInNlYy1mZXRjaC1zaXRlIjogInNhbWUtc2l0ZSIsCiAgICAgICJzZWMtZmV0Y2gtbW9kZSI6ICJjb3JzIiwKICAgICAgInNlYy1mZXRjaC1kZXN0IjogImVtcHR5IiwKICAgICAgInJlZmVyZXIiOiAiaHR0cHM6Ly90Zy10YXAtbWluaWFwcC5sYWJvcnguaW8vIiwKICAgICAgImFjY2VwdC1lbmNvZGluZyI6ICJnemlwLCBkZWZsYXRlLCBiciwgenN0ZCIsCiAgICAgICJhY2NlcHQtbGFuZ3VhZ2UiOiAidmktVk4sdmk7cT0wLjksZW4tVVM7cT0wLjgsZW47cT0wLjciLAogICAgICAicHJpb3JpdHkiOiAidT0xLCBpIn0KICAgICN0b2tlbiwgYmFsYW5jZSwgbGV2ZWwsIGxldmVsSW5mbyA9IGdldFVzZXJJbmZvKGhlYWRlcnMsIGRhdGEsIHByb3hpZXMpCiAgICBoZWFkZXJzWyJBdXRob3JpemF0aW9uIl0gPSBhdXRob3JpemF0aW9uCiAgICBiYWxhbmNlLCB0aW1lU3RhcnRGYXJtLCB0aW1lRmFybSwgcmV3YXJkRmFybSA9IGZhcm1JbmZvKGhlYWRlcnMsIHByb3hpZXMpCiAgICBwcmludChmIiIie8SR4bqtbX17xJFlbn3Cq8KrwqvCq8KrwqvCq8KrwqvCq8KrwqvCq8KrwqvCq3tsYW19W3t2w6BuZ0JHfXvEkeG7j31USMOUTkcgVElOIFTDgEkgS0hP4bqiTiBUSU1FRkFSTXvEkWVuQkd9e2xhbX1de8SRZW59wrvCu8K7wrvCu8K7wrvCu8K7wrvCu8K7wrvCu8K7wrvCu1xue8SRZW5944CY8J+RpOOAmXt0cuG6r25nfVTDoGkga2hv4bqjbiB7xJHhu499OiB7dHLhuq9uZ30oe2jhu5NuZ317YWNjb3VudC5zcGxpdCgnXycpWzFdfXt0cuG6r25nfSlcbnvEkWVufeOAmPCfqpnjgJl7dHLhuq9uZ31T4buRIETGsCB7xJHhu499OiB7dsOgbmd9e2JhbGFuY2V9XG57xJFlbn3jgJjwn4yP44CZe3Ry4bqvbmd9SVAge8SR4buPfToge27DonV9e2lwfSB7bOG7pWN9wrvCu8K7IHt0cuG6r25nfUZha2UgSVAge8SR4buPfToge2xhbX17ZmFrZWlwfVxuIiIiKQogICAgc3RhcnRfdGltZSA9IGRhdGV0aW1lLm5vdygpCiAgICBwcmludChmInvEkeG7j31cMDMzWzE7MzM7NDBtQuG6rlQgxJDhuqZVIENI4bqgWSBUT09MIHt0aMaw4budbmd9e8SR4bqtbX17xJHhu499wrsge8SRZW59W3t2w6BuZ317c3RhcnRfdGltZS5zdHJmdGltZSgnJUg6JU06JVMnKX17xJFlbn1dXG4iKQogICAgb3B0aW9ucywgc3Rha2VzID0gU1RBS0lOR19BQ1RJVkUoaGVhZGVycywgcHJveGllcykKICAgIGZvciBzdGFrZSBpbiBzdGFrZXM6CiAgICAgIGFtb3VudCA9IHN0YWtlWyJhbW91bnQiXQogICAgICBwZXJjZW50ID0gc3Rha2VbInBlcmNlbnQiXQogICAgICBkYXkgPSBzdGFrZVsiZHVyYXRpb24iXQogICAgICBwcmludChmInvEkeG7j33in6l7dsOgbmd94p+pe2zhu6VjfeKfqSB7dHLhuq9uZ31IaeG7h24gxJFhbmcge2xhbX1TVEFLSU5HIHt2w6BuZ317YW1vdW50Oix9IHt0cuG6r25nfXbhu5tpIG9wdGlvbiB7aOG7k25nfXtwZXJjZW50fSV7xJFlbn0ve2jhu5NuZ317ZGF5fW5nw6B5IikKICAgIHByaW50KCkKICAgIHRhc2tzID0gdGFza3NJbmZvKGhlYWRlcnMsIHByb3hpZXMpCiAgICBmb3IgdGFzayBpbiB0YXNrczoKICAgICAgaWRfdGFzayA9IHRhc2tbImlkIl0KICAgICAgdGl0bGVfdGFzayA9IHRhc2tbInRpdGxlIl0KICAgICAgcmV3YXJkX3Rhc2sgPSB0YXNrWyJyZXdhcmQiXQogICAgICBpZiAiU3Vic2NyaWJlIiBub3QgaW4gdGl0bGVfdGFzazoKICAgICAgICBpZiAic3VibWlzc2lvbiIgaW4gdGFzazoKICAgICAgICAgIGlmIHRhc2tbInN1Ym1pc3Npb24iXVsic3RhdHVzIl0gPT0gIkNMQUlNRUQiOgogICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgaWYgdGFza1sic3VibWlzc2lvbiJdWyJzdGF0dXMiXSA9PSAiQ09NUExFVEVEIjoKICAgICAgICAgICAgc3RhdHVzID0gY2xhaW1UYXNrKGhlYWRlcnMsIGlkX3Rhc2ssIHByb3hpZXMpCiAgICAgICAgICAgIGlmIHN0YXR1cyA9PSAyMDA6CiAgICAgICAgICAgICAgYmFsYW5jZSA9IGdldEJhbGFuY2UoaGVhZGVycywgcHJveGllcykKICAgICAgICAgICAgICBub3dfdGltZSA9IGRhdGV0aW1lLm5vdygpLnN0cmZ0aW1lKCIlSDolTTolUyIpCiAgICAgICAgICAgICAgcHJpbnQoZiJ7xJHhu4994p+oe3bDoG5nfXtub3dfdGltZX17xJHhu4994p+pe3Ry4bqvbmd9IEhvw6BuIHRow6BuaCB7bGFtfXt0aXRsZV90YXNrfSB7dsOgbmd9K3tyZXdhcmRfdGFza30ge8SRZW59wrsge3bDoG5nfXtiYWxhbmNlOix9IikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICBub3dfdGltZSA9IGRhdGV0aW1lLm5vdygpLnN0cmZ0aW1lKCIlSDolTTolUyIpCiAgICAgICAgICAgICAgcHJpbnQoZiJ7xJHhu4994p+oe3bDoG5nfXtub3dfdGltZX17xJHhu4994p+pe8SR4buPfSBIb8OgbiB0aMOgbmgge2xhbX17dGl0bGVfdGFza30ge8SR4buPfVRI4bqkVCBC4bqgSSIpCiAgICAgICAgICBlbHNlOgogICAgICAgICAgICBub3dfdGltZSA9IGRhdGV0aW1lLm5vdygpLnN0cmZ0aW1lKCIlSDolTTolUyIpCiAgICAgICAgICAgIHByaW50KGYie8SR4buPfeKfqHt2w6BuZ317bm93X3RpbWV9e8SR4buPfeKfqXvEkeG7j30gVG9vbCBraMO0bmcgdGjhu4MgbMOgbSBuaGnhu4dtIHbhu6Uge2xhbX17dGl0bGVfdGFza30iKQogICAgICAgIGVsc2U6CiAgICAgICAgICBzdGF0dXMgPSBzdGFydFRhc2soaGVhZGVycywgaWRfdGFzaywgcHJveGllcykKICAgICAgICAgIGlmIHN0YXR1cyA9PSAyMDA6CiAgICAgICAgICAgIHN0YXR1cyA9IGNsYWltVGFzayhoZWFkZXJzLCBpZF90YXNrLCBwcm94aWVzKQogICAgICAgICAgICBpZiBzdGF0dXMgPT0gMjAwOgogICAgICAgICAgICAgIGJhbGFuY2UgPSBnZXRCYWxhbmNlKGhlYWRlcnMsIHByb3hpZXMpCiAgICAgICAgICAgICAgbm93X3RpbWUgPSBkYXRldGltZS5ub3coKS5zdHJmdGltZSgiJUg6JU06JVMiKQogICAgICAgICAgICAgIHByaW50KGYie8SR4buPfeKfqHt2w6BuZ317bm93X3RpbWV9e8SR4buPfeKfqXt0cuG6r25nfSBIb8OgbiB0aMOgbmgge2xhbX17dGl0bGVfdGFza30ge3bDoG5nfSt7cmV3YXJkX3Rhc2t9IHvEkWVufcK7IHt2w6BuZ317YmFsYW5jZTosfSIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgbm93X3RpbWUgPSBkYXRldGltZS5ub3coKS5zdHJmdGltZSgiJUg6JU06JVMiKQogICAgICAgICAgICAgIHByaW50KGYie8SR4buPfeKfqHt2w6BuZ317bm93X3RpbWV9e8SR4buPfeKfqXvEkeG7j30gSG/DoG4gdGjDoG5oIHtsYW19e3RpdGxlX3Rhc2t9IHvEkeG7j31USOG6pFQgQuG6oEkiKQogICAgICAgICAgZWxzZToKICAgICAgICAgICAgbm93X3RpbWUgPSBkYXRldGltZS5ub3coKS5zdHJmdGltZSgiJUg6JU06JVMiKQogICAgICAgICAgICBwcmludChmInvEkeG7j33in6h7dsOgbmd9e25vd190aW1lfXvEkeG7j33in6l7xJHhu499IEzDoG0gTlYge2xhbX17dGl0bGVfdGFza30ge8SR4buPfVRI4bqkVCBC4bqgSSIpCiAgICAiIiJpZiBzdHIobGV2ZWxJbmZvWy0xXVsibGV2ZWwiXSkgIT0gc3RyKGxldmVsKToKICAgICAgd2hpbGUgYmFsYW5jZSA+IGxldmVsSW5mb1tsZXZlbCsxXVsicHJpY2UiXToKICAgICAgICBiYWxhbmNlLCBsZXZlbCwgdGltZUZhcm0sIHJld2FyZEZhcm0gPSB1cGdyYWRlKGhlYWRlcnMsIHByb3hpZXMpCiAgICAgICAgbm93X3RpbWUgPSBkYXRldGltZS5ub3coKS5zdHJmdGltZSgiJUg6JU06JVMiKQogICAgICAgIHByaW50KGYie8SR4buPfeKfqHt2w6BuZ317bm93X3RpbWV9e8SR4buPfeKfqSB7bOG7pWN9xJDDoyBuw6JuZyBj4bqlcCBsw6puIGxldmVsIHt0cuG6r25nfSh7bGFtfXtsZXZlbH17dHLhuq9uZ30pIHvEkeG7j30te2xldmVsSW5mb1tsZXZlbF1bJ3ByaWNlJ106LH0ge8SRZW59wrsge3bDoG5nfXtiYWxhbmNlOix9IikiIiIKICAgIGlmIHN0cihkYXRldGltZS5ub3coKS5zdHJmdGltZSgiJWQvJW0vJVkvJUgvJU0vJVMiKSkgPCBhbnN3ZXJbImRhdGVfZXhwaXJlZCJdIGFuZCBhbnN3ZXJbImFuc3dlcl9xdWVzdCJdICE9ICIiOgogICAgICBpc0NvcnJlY3QgPSBEQUlMWV9RVUVTVChoZWFkZXJzLCAiIiwgImdldCIsIHByb3hpZXM9Tm9uZSkKICAgICAgaWYgaXNDb3JyZWN0ID09IEZhbHNlOgogICAgICAgIGlzQ29ycmVjdCA9IERBSUxZX1FVRVNUKGhlYWRlcnMsIHsiYW5zd2VyIjphbnN3ZXJbImFuc3dlcl9xdWVzdCJdfSwgInBvc3QiLCBwcm94aWVzPU5vbmUpCiAgICAgICAgbm93X3RpbWUgPSBkYXRldGltZS5ub3coKS5zdHJmdGltZSgiJUg6JU06JVMiKQogICAgICAgIGlmIGlzQ29ycmVjdCA9PSBUcnVlOgogICAgICAgICAgYmFsYW5jZSA9IGdldEJhbGFuY2UoaGVhZGVycywgcHJveGllcykKICAgICAgICAgIHByaW50KGYie8SR4buPfeKfqHt2w6BuZ317bm93X3RpbWV9e8SR4buPfeKfqSB7dHLhuq9uZ33EkMOjIGhvw6BuIHRow6BuaCB7bGFtfU9yYWNsZSBvZiBUaW1lIHvEkWVufcK7IHt2w6BuZ317YmFsYW5jZX0iKQogICAgICAgIGVsc2U6CiAgICAgICAgICBwcmludChmInvEkeG7j33in6h7dsOgbmd9e25vd190aW1lfXvEkeG7j33in6kge8SR4buPfVRy4bqjIGzhu51pIHtsYW19T3JhY2xlIG9mIFRpbWUge8SR4buPfXRo4bqldCBi4bqhaSIpCiAgICBiYWxhbmNlID0gYmFsYW5jZS5zcGxpdCgnLicpWzBdCiAgICBpZiBiYWxhbmNlID4gIjAiIGFuZCBsZW4oc3Rha2VzKSA8IDM6CiAgICAgIG9wdGlvbnMsIHN0YWtlcyA9IFNUQUtJTkcoaGVhZGVycywgeyJvcHRpb25JZCI6IjEiLCJhbW91bnQiOmJhbGFuY2V9LCBwcm94aWVzKQogICAgICBhbW91bnQgPSBzdGFrZXNbLTFdWyJhbW91bnQiXQogICAgICBwZXJjZW50ID0gc3Rha2VzWy0xXVsicGVyY2VudCJdCiAgICAgIGRheSA9IHN0YWtlc1stMV1bImR1cmF0aW9uIl0KICAgICAgbm93X3RpbWUgPSBkYXRldGltZS5ub3coKS5zdHJmdGltZSgiJUg6JU06JVMiKQogICAgICBwcmludChmInvEkeG7j33in6h7dsOgbmd9e25vd190aW1lfXvEkeG7j33in6kge3Ry4bqvbmd9QuG6r3QgxJHhuqd1IHtsYW19U1RBS0lORyB7dsOgbmd9e2Ftb3VudDosfSB7dHLhuq9uZ3124bubaSBvcHRpb24ge2jhu5NuZ317cGVyY2VudH0le8SRZW59L3to4buTbmd9e2RheX1uZ8OgeSIpCiAgICB0aW1lU3RhcnQgPSBkYXRldGltZS5zdHJwdGltZSh0aW1lU3RhcnRGYXJtLCAiJVktJW0tJWRUJUg6JU06JVMuJWZaIikKICAgIHRpbWVTdGFydCA9IHRpbWVTdGFydC5yZXBsYWNlKHR6aW5mbz10aW1lem9uZS51dGMpCiAgICB0aW1lc3RhbXAgPSBpbnQodGltZVN0YXJ0LnRpbWVzdGFtcCgpICogMTAwMCkKICAgIGlmIHRpbWVzdGFtcCt0aW1lRmFybSoxMDAwIDwgaW50KHRpbWUudGltZSgpKjEwMDApOgogICAgICBiYWxhbmNlID0gY2xhaW1GYXJtKGhlYWRlcnMsIHByb3hpZXMpCiAgICAgIG5vd190aW1lID0gZGF0ZXRpbWUubm93KCkuc3RyZnRpbWUoIiVIOiVNOiVTIikKICAgICAgcHJpbnQoZiJ7xJHhu4994p+oe3bDoG5nfXtub3dfdGltZX17xJHhu4994p+pIHts4bulY33EkMOjIENsYWltIEZBUk0ge3bDoG5nfSt7cmV3YXJkRmFybTosfSB7xJHhu499wrsge3bDoG5nfXtiYWxhbmNlOix9IikKICAgICAgYmFsYW5jZSwgdGltZVN0YXJ0RmFybSwgdGltZUZhcm0sIHJld2FyZEZhcm0gPSBzdGFydEZhcm0oaGVhZGVycywgcHJveGllcykKICAgIGVsc2U6CiAgICAgIG5vd190aW1lID0gZGF0ZXRpbWUubm93KCkuc3RyZnRpbWUoIiVIOiVNOiVTIikKICAgICAgcHJpbnQoZiJ7xJHhu4994p+oe3bDoG5nfXtub3dfdGltZX17xJHhu4994p+pIHvEkeG7j31DaMawYSDEkeG6v24gdGjhu51pIGdpYW4gbmjhuq1uIHtsYW19RmFybSBSZXdhcmRzIikKICAgIHByaW50KGYie8SR4buPfeKfqXt2w6BuZ33in6l7bOG7pWN94p+pIHt0cuG6r25nfUjhur5UIE5ISeG7hk0gVuG7pCBWw4AgTMav4buiVCBDTEFJTSB7xJHhu499wrsge3bDoG5nfcSQ4buUSSBUw4BJIEtIT+G6ok4iKQpSVU5fVElNRUZBUk0oKQ=="